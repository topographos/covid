---
title: "Scotland"
subtitle: "COVID-19"
author: ""
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---
```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE}
# get todays dates and times
library(dplyr)
library(tidyr)
library(lubridate)
library(readr)
library(ggplot2)
library(rvest)
library(sf)
library(stringr)
library(tmap)
library(kableExtra)
library(gghighlight)
library(hrbrthemes)
library(gganimate)
```

```{r echo=FALSE, fig.align='right', message=FALSE, warning=FALSE, paged.print=FALSE, include= FALSE}
#load total cases for Scotland
scotland_totals = read_csv("data/scotland_totals.csv")

scotland_totals = scotland_totals %>% 
mutate(new_cases = (ConfirmedCases - lag(ConfirmedCases)))  %>% # new daily cases 
mutate(pct_change = new_cases / lag(ConfirmedCases) * 100) # percentage change

current_cases = scotland_totals %>% 
  filter(Date == max(Date) ) %>% 
  select(ConfirmedCases)
  
current_deaths = scotland_totals %>% 
  filter(Date == max(Date) ) %>% 
  select(Deaths)

```

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE}
# get today's data
date= today()
date_char = as.character.Date(date)

```
> <span style="color: #ba0000;">Cases: `r current_cases` </span>  <span style="color: black;">Deaths: `r current_deaths` </span> 

```{r, echo=FALSE, out.width= 600, fig.cap="", fig.align='left'}
knitr::include_graphics("covid_anim_plot.gif")
```

## Number of Coronavirus cases by NHS Health Board


```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE}
# scrape data from the website into a table

url = xml2::read_html("https://www.gov.scot/coronavirus-covid-19/")

selector_name<-"table"

cases_latest <- html_node(x = url, css = selector_name) %>%
  html_table(trim = TRUE, header = TRUE) %>%
  mutate(cases = `Positive cases`) %>%
  mutate(cases = as.numeric(cases)) %>% 
  rename(HBName = `Health board`,
         !!date_char := `Positive cases`) %>%
  mutate(HBName = trimws(as.character(HBName))) %>%
  mutate(HBName = replace(HBName, str_detect(HBName, "Ayrshire"), "Ayrshire and Arran"))


```

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, paged.print=FALSE, include=FALSE}
# make a join to the Health Boards boundaries

# load  healthboards dataset

hb_shp = st_read("data/SG_NHS_HealthBoards_2019.shp") %>% 
  select(HBName) %>% 
  mutate(HBName = trimws(as.character(HBName)))
  

# join covid table to health board geofraphies

hb_cases = left_join(hb_shp, cases_latest, by = "HBName")


#st_write(hb_cases, "hb_cases.shp", delete_layer = TRUE)
#hb_cases = st_read("hb_cases.shp")


```

```{r eval=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# update master table



scotland_cases = read_csv("data/scotland_cases.csv") %>% 
  left_join(cases_latest, by = "HBName") %>% 
  select(-cases)


write_csv(scotland_cases, "data/scotland_cases.csv")


```


```{r echo=FALSE, fig.align='left', message=FALSE, warning=FALSE, paged.print=FALSE}



#make a map
tmap_mode("plot")
legend_title = paste0("Data from ", date_char)
map_hb = tm_shape(hb_cases) +
  tm_polygons( col = "cases", 
               n= 5,
               style = "jenks", 
               palette = "Reds",
               title = legend_title,
               colorNA = "white",
               textNA = "no cases"
               ) +
  tm_layout(frame = FALSE,
            title = "Positive cases of COVID-19",
            )

#save map to png
tmap_save(map_hb, "map_hb.png", dpi = 200)

#bubble map
map_cases = tm_shape(hb_cases) +
  tm_borders() +
  tm_bubbles(col = "cases",
             n = 5,
             style = "jenks",
             palette = "Reds",
             size = "cases",
             title.size = "Number of cases",
             legend.col.show = FALSE,
             legend.size.show = FALSE,
             shape = 19) +
  tm_layout(frame = FALSE,
  )

tmap_arrange(map_hb, map_cases)
```

## Pandemic Growth

```{r echo=FALSE, fig.align='left', message=FALSE, warning=FALSE, paged.print=FALSE, }




#  set theme
theme_set(theme_minimal())
#plot 
ggplot(scotland_totals)+
  geom_line(aes(x=Date, y=ConfirmedCases), color='#ba0000') +
  geom_line(aes(x=Date, y=Deaths, lty = 'Deaths'), color='black') +
  ggtitle("Total Number of Confirmed Cases and Deaths") +
  labs(y = "Cases") +
  scale_x_date(date_breaks = '1 week', date_labels = '%m %d') +
  theme(
    legend.position = "right",
    panel.grid.minor = element_blank()) +
  scale_linetype('')


```


```{r echo=FALSE, fig.align='left', message=FALSE, warning=FALSE, paged.print=FALSE, }

# pivot longer
scotland_cases = read_csv("data/scotland_cases.csv")
covid_longer = scotland_cases %>%
pivot_longer(-HBName, names_to = "Date", values_to = "Cases")  %>%
mutate(Date = as.Date(Date)) %>% 
replace(is.na(.), 0)

#  set theme
theme_set(theme_minimal())
#plot 
ggplot(covid_longer)+
 geom_line(aes(x=Date, y=Cases, color = HBName), color='#ba0000') +
ggtitle("Confirmed Cases by NHS Health Board") +
 gghighlight(max(Cases) > 1, use_direct_label = FALSE) +
 scale_x_date(date_breaks = '1 week', date_labels = '%m %d') +
 theme(legend.position = "none",
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
 facet_wrap(~ HBName)


```




```{r eval=FALSE, fig.align='left', message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
#produce animation

covid = ggplot(scotland_totals)+
  geom_line(aes(x=Date, y=Deaths), color='black') +
  geom_point(aes(x=Date, y=Deaths), color='black')+
  geom_line(aes(x=Date, y=ConfirmedCases), color='#ba0000') +
  geom_point(aes(x=Date, y=ConfirmedCases), color='#ba0000')+
  labs(y = "Cases") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  scale_x_date(date_breaks = '1 week', date_labels = '%m %d') +
  scale_linetype('')

covid_anim = covid + transition_reveal(Date)

anim_save("covid_anim_plot.gif", covid_anim)



```


```{r echo=FALSE, fig.align='left', message=FALSE, warning=FALSE, paged.print=FALSE}
#daily

scotland_totals %>% filter(new_cases >0 ) %>% 
  ggplot()+
  geom_line(aes(x=Date, y=new_cases, lty = 'Daily Increase'), color='#ba0000') +
  geom_point(aes(x=Date, y=new_cases), color='#ba0000') +
  geom_line(aes(x=Date, y=pct_change, lty = 'Percentage Change'), color='black') +
  geom_point(aes(x=Date, y=pct_change), color='black') +
  ggtitle("Daily Confirmed Cases") +
  labs(y = "Number of Cases") +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank()) +
  scale_x_date(date_breaks = '1 week', date_labels = '%m %d') +
  scale_linetype('')
```



## Interactive

```{r echo=FALSE, fig.align='left', message=FALSE, warning=FALSE, paged.print=FALSE}
#interctive map
tmap_mode("view")
map_hb
```

## Data

The maps and plot are daily updated using data published by the Scottish Government:

1. COVID-19 statistics ^[https://www.gov.scot/coronavirus-covid-19/]
2. NHS Health Boards ^[https://www.spatialdata.gov.scot/geonetwork/srv/eng/catalog.search#/metadata/f12c3826-4b4b-40e6-bf4f-77b9ed01dc14]

*'Historical'* cases up to 18th March come from `fantastic` work by [Tom White](http://tom-e-white.com/covid-19-uk-data/) covering UK.^[http://tom-e-white.com/covid-19-uk-data/]